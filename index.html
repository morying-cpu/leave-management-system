<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบแจ้งลาออนไลน์ - วิทยาลัยเสนาธิการทหาร</title>
    <style>
        /* Tailwind CSS Reset and Base Styles */
        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; }
        ::before, ::after { --tw-content: ''; }
        html { line-height: 1.5; -webkit-text-size-adjust: 100%; -moz-tab-size: 4; tab-size: 4; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; font-feature-settings: normal; font-variation-settings: normal; }
        body { margin: 0; line-height: inherit; }
        hr { height: 0; color: inherit; border-top-width: 1px; }
        abbr:where([title]) { text-decoration: underline dotted; }
        h1, h2, h3, h4, h5, h6 { font-size: inherit; font-weight: inherit; }
        a { color: inherit; text-decoration: inherit; }
        b, strong { font-weight: bolder; }
        code, kbd, samp, pre { font-family: ui-monospace, SFMono-Regular, "Consolas", "Liberation Mono", "Menlo", monospace; font-size: 1em; }
        small { font-size: 80%; }
        sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
        sub { bottom: -0.25em; }
        sup { top: -0.5em; }
        table { text-indent: 0; border-color: inherit; border-collapse: collapse; }
        button, input, optgroup, select, textarea { font-family: inherit; font-feature-settings: inherit; font-variation-settings: inherit; font-size: 100%; font-weight: inherit; line-height: inherit; color: inherit; margin: 0; padding: 0; }
        button, select { text-transform: none; }
        button, [type='button'], [type='reset'], [type='submit'] { -webkit-appearance: button; background-color: transparent; background-image: none; }
        :-moz-focusring { outline: auto; }
        :-moz-ui-invalid { box-shadow: none; }
        progress { vertical-align: baseline; }
        ::-webkit-inner-spin-button, ::-webkit-outer-spin-button { height: auto; }
        [type='search'] { -webkit-appearance: textfield; outline-offset: -2px; }
        ::-webkit-search-decoration { -webkit-appearance: none; }
        ::-webkit-file-upload-button { -webkit-appearance: button; font: inherit; }
        summary { display: list-item; }
        blockquote, dl, dd, h1, h2, h3, h4, h5, h6, hr, figure, p, pre { margin: 0; }
        fieldset { margin: 0; padding: 0; }
        legend { padding: 0; }
        ol, ul, menu { list-style: none; margin: 0; padding: 0; }
        dialog { padding: 0; }
        textarea { resize: vertical; }
        input::placeholder, textarea::placeholder { opacity: 1; color: #9ca3af; }
        button, [role="button"] { cursor: pointer; }
        :disabled { cursor: default; }
        img, svg, video, canvas, audio, iframe, embed, object { display: block; vertical-align: middle; }
        img, video { max-width: 100%; height: auto; }
        [hidden] { display: none; }

        /* Tailwind Utility Classes */
        .fixed { position: fixed; }
        .absolute { position: absolute; }
        .relative { position: relative; }
        .inset-0 { inset: 0px; }
        .top-20 { top: 5rem; }
        .right-20 { right: 5rem; }
        .bottom-20 { bottom: 5rem; }
        .left-20 { left: 5rem; }
        .z-40 { z-index: 40; }
        .z-50 { z-index: 50; }
        .z-100 { z-index: 100; }
        .z-1000 { z-index: 1000; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .mx-4 { margin-left: 1rem; margin-right: 1rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mr-3 { margin-right: 0.75rem; }
        .ml-4 { margin-left: 1rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .block { display: block; }
        .inline-block { display: inline-block; }
        .flex { display: flex; }
        .grid { display: grid; }
        .hidden { display: none; }
        .w-full { width: 100%; }
        .w-16 { width: 4rem; }
        .w-20 { width: 5rem; }
        .h-16 { height: 4rem; }
        .h-20 { height: 5rem; }
        .max-w-md { max-width: 28rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-w-6xl { max-width: 72rem; }
        .max-h-96 { max-height: 24rem; }
        .min-h-screen { min-height: 100vh; }
        .flex-1 { flex: 1 1 0%; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .space-x-2 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.5rem; }
        .space-x-3 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.75rem; }
        .space-x-4 > :not([hidden]) ~ :not([hidden]) { margin-left: 1rem; }
        .space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
        .space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.5rem; }
        .overflow-y-auto { overflow-y: auto; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-full { border-radius: 9999px; }
        .border-2 { border-width: 2px; }
        .border-dashed { border-style: dashed; }
        .border-gray-200 { border-color: #e5e7eb; }
        .border-gray-300 { border-color: #d1d5db; }
        .bg-white { background-color: #fff; }
        .bg-black { background-color: #000; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-500 { background-color: #6b7280; }
        .bg-gray-600 { background-color: #4b5563; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-green-500 { background-color: #22c55e; }
        .bg-green-600 { background-color: #16a34a; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-yellow-500 { background-color: #eab308; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-red-600 { background-color: #dc2626; }
        .bg-purple-50 { background-color: #faf5ff; }
        .bg-purple-500 { background-color: #a855f7; }
        .bg-purple-600 { background-color: #9333ea; }
        .bg-indigo-600 { background-color: #4f46e5; }
        .bg-cyan-600 { background-color: #0891b2; }
        .bg-orange-600 { background-color: #ea580c; }
        .bg-opacity-50 { background-color: rgb(0 0 0 / 0.5); }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .px-8 { padding-left: 2rem; padding-right: 2rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .py-12 { padding-top: 3rem; padding-bottom: 3rem; }
        .pb-8 { padding-bottom: 2rem; }
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        .text-6xl { font-size: 3.75rem; line-height: 1; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-white { color: #fff; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-900 { color: #111827; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-800 { color: #1e40af; }
        .text-green-600 { color: #16a34a; }
        .text-green-800 { color: #166534; }
        .text-yellow-600 { color: #ca8a04; }
        .text-yellow-800 { color: #854d0e; }
        .text-red-500 { color: #ef4444; }
        .text-red-600 { color: #dc2626; }
        .text-red-700 { color: #b91c1c; }
        .text-purple-600 { color: #9333ea; }
        .text-purple-800 { color: #6b21a8; }
        .opacity-50 { opacity: 0.5; }
        .opacity-75 { opacity: 0.75; }
        .opacity-80 { opacity: 0.8; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .duration-300 { transition-duration: 300ms; }
        .cursor-pointer { cursor: pointer; }
        .cursor-default { cursor: default; }
        .hover\:bg-blue-50:hover { background-color: #eff6ff; }
        .hover\:bg-blue-600:hover { background-color: #2563eb; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .hover\:bg-blue-800:hover { background-color: #1e40af; }
        .hover\:bg-gray-600:hover { background-color: #4b5563; }
        .hover\:bg-gray-700:hover { background-color: #374151; }
        .hover\:bg-green-600:hover { background-color: #16a34a; }
        .hover\:bg-green-700:hover { background-color: #15803d; }
        .hover\:bg-red-600:hover { background-color: #dc2626; }
        .hover\:bg-red-700:hover { background-color: #b91c1c; }
        .hover\:bg-purple-600:hover { background-color: #9333ea; }
        .hover\:bg-purple-700:hover { background-color: #7c3aed; }
        .hover\:bg-indigo-700:hover { background-color: #4338ca; }
        .hover\:bg-cyan-700:hover { background-color: #0e7490; }
        .hover\:bg-orange-700:hover { background-color: #c2410c; }
        .hover\:bg-yellow-600:hover { background-color: #ca8a04; }
        .hover\:text-gray-700:hover { color: #374151; }
        .hover\:text-red-700:hover { color: #b91c1c; }
        .hover\:border-blue-400:hover { border-color: #60a5fa; }
        .hover\:scale-105:hover { transform: scale(1.05); }
        .hover\:shadow-lg:hover { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }

        /* Responsive Design */
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .md\:col-span-2 { grid-column: span 2 / span 2; }
            .md\:block { display: block; }
            .md\:p-8 { padding: 2rem; }
            .md\:text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        }

        @media (min-width: 1024px) {
            .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Sarabun', sans-serif !important;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .form-input {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        
        .form-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        
        .tab-button {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
            transition: all 0.4s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .tab-button.active {
            background: rgba(255, 255, 255, 0.95);
            color: #374151;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        
        .tab-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .floating-icon {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .success-animation {
            animation: successPulse 0.6s ease-out;
        }
        
        @keyframes successPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 400px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .admin-nav-btn {
            transition: all 0.3s ease;
        }
        
        .admin-nav-btn.active {
            transform: scale(1.05);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .data-item {
            transition: all 0.3s ease;
        }
        
        .data-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .file-drop-zone {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        
        .file-drop-zone.dragover {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.05);
        }
        
        .version-badge {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 100;
        }
    </style>
</head>
<body>


    <!-- Configuration -->
    <script>
    window.CONFIG = {
        APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzUnzazEwnShgTjsbmZpYATHj1dt23g6YCSRsmUzt0YeoiTKhdI8KG-ECL5kQeIA13b/exec',
        SHEET_ID: '1jd3plZsNT6qb6ng5DSGB77fifu4xF0rd5gxcybkNN98',
        TELEGRAM_BOT_TOKEN: '8204347040:AAGmBoXELeLG5-j4BshY1dEtDm0zWFzzTjU',
        TELEGRAM_CHAT_ID: '-4802732204',
        DRIVE_FOLDER_ID: '16Cxw0pWS4EjsFDQPGS7porWnxZJhSrlb',
        MAX_FILE_SIZE: 10 * 1024 * 1024,
        ALLOWED_FILE_TYPES: ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'],
        DEMO_MODE: false, // Online mode - connects to real Google Sheets and Telegram
        TIMEOUT: 30000,
        SHEET_HEADERS: ['เวลาที่ส่ง', 'ชื่อ-นามสกุล', 'หลักสูตร', 'ประเภทการลา', 'วันที่เริ่มลา', 'วันที่สิ้นสุดการลา', 'ช่วงเวลา (ถ้ามี)', 'ข้อมูลไฟล์แนบ (ถ้ามี)']
    };
    </script>

    <!-- Header -->
    <header class="glass-nav p-6 mb-8">
        <div class="max-w-6xl mx-auto">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg floating-icon">
                        <span class="text-2xl">📋</span>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-4xl font-bold text-white mb-1">ระบบแจ้งลาออนไลน์</h1>
                        <p class="text-white/80">วิทยาลัยเสนาธิการทหาร</p>
                    </div>
                </div>
                <div class="hidden md:block text-right">
                    <div class="glass-card rounded-xl p-4">
                        <div class="text-sm text-gray-600" id="currentDateTime"></div>
                        <div class="text-xs text-gray-500 mt-1">เวลาปัจจุบัน</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 pb-8">
        <!-- Tab Navigation -->
        <div class="glass-nav rounded-2xl p-6 mb-8 shadow-xl">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="showTab('form')" id="formTab" class="tab-button active px-8 py-8 rounded-2xl font-bold text-xl flex flex-col items-center space-y-4 transition-all duration-300 hover:scale-105">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <span class="text-4xl">✏️</span>
                    </div>
                    <span class="text-center">แจ้งลาใหม่</span>
                    <div class="text-base opacity-75 text-center">สร้างคำขอลาใหม่</div>
                </button>
                <button onclick="showTab('admin')" id="adminTab" class="tab-button px-8 py-8 rounded-2xl font-bold text-xl flex flex-col items-center space-y-4 transition-all duration-300 hover:scale-105">
                    <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <span class="text-4xl">⚙️</span>
                    </div>
                    <span class="text-center">จัดการระบบ</span>
                    <div class="text-base opacity-75 text-center">เครื่องมือผู้ดูแล</div>
                </button>
            </div>
        </div>

        <!-- Form Tab -->
        <div id="formContent" class="tab-content">
            <div class="glass-card rounded-2xl p-6 md:p-8 fade-in">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 floating-icon">
                        <span class="text-3xl">✏️</span>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">แบบฟอร์มแจ้งลา</h2>
                    <p class="text-gray-600">กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง</p>
                </div>

                <form id="leaveForm" class="space-y-6" novalidate>
                    <!-- Personal Information -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="studentName" class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="mr-2">👤</span>ชื่อ-นามสกุล *
                            </label>
                            <input type="text" id="studentName" name="studentName" required
                                class="form-input w-full px-4 py-3 rounded-xl"
                                placeholder="กรอกชื่อ-นามสกุล">
                        </div>

                        <div>
                            <label for="course" class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="mr-2">🎓</span>หลักสูตร *
                            </label>
                            <select id="course" name="course" required
                                class="form-input w-full px-4 py-3 rounded-xl">
                                <option value="">เลือกหลักสูตร</option>
                                <option value="หลักสูตรเสนาธิการทหาร">หลักสูตรเสนาธิการทหาร</option>
                                <option value="หลักสูตรนายทหารอาวุโส">หลักสูตรนายทหารอาวุโส</option>
                                <option value="หลักสูตรเสนาธิการร่วม">หลักสูตรเสนาธิการร่วม</option>
                            </select>
                        </div>
                    </div>

                    <!-- Leave Information -->
                    <div>
                        <label for="leaveType" class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="mr-2">🏷️</span>ประเภทการลา *
                        </label>
                        <select id="leaveType" name="leaveType" required
                            class="form-input w-full px-4 py-3 rounded-xl">
                            <option value="">เลือกประเภทการลา</option>
                            <option value="ลากิจ">ลากิจ</option>
                            <option value="ลาป่วย">ลาป่วย</option>
                            <option value="ลารายชั่วโมง">ลารายชั่วโมง</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="mr-2">▶️</span>วันที่เริ่มลา *
                            </label>
                            <input type="date" id="startDate" name="startDate" required
                                class="form-input w-full px-4 py-3 rounded-xl">
                        </div>

                        <div>
                            <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="mr-2">⏹️</span>วันที่สิ้นสุดการลา *
                            </label>
                            <input type="date" id="endDate" name="endDate" required
                                class="form-input w-full px-4 py-3 rounded-xl">
                        </div>
                    </div>

                    <!-- Time Slot (for hourly leave) -->
                    <div id="timeSlotSection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            <span class="mr-2">🕐</span>ช่วงเวลา (สำหรับลารายชั่วโมง)
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="glass-card p-4 rounded-xl cursor-pointer hover:bg-blue-50 transition-colors">
                                <input type="radio" name="timeSlot" value="0930-1130" class="mr-3">
                                <div>
                                    <div class="font-medium">ช่วงเช้า</div>
                                    <div class="text-sm text-gray-500">09:30 - 11:30</div>
                                </div>
                            </label>
                            <label class="glass-card p-4 rounded-xl cursor-pointer hover:bg-blue-50 transition-colors">
                                <input type="radio" name="timeSlot" value="1230-1530" class="mr-3">
                                <div>
                                    <div class="font-medium">ช่วงบ่าย</div>
                                    <div class="text-sm text-gray-500">12:30 - 15:30</div>
                                </div>
                            </label>
                        </div>
                    </div>



                    <!-- File Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            <span class="mr-2">📎</span>ไฟล์แนบ (ถ้ามี)
                        </label>
                        <div class="file-drop-zone glass-card border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 transition-colors"
                             onclick="document.getElementById('fileInput').click()">
                            <span class="text-4xl mb-4 block">☁️</span>
                            <p class="text-gray-600 mb-2">คลิกเพื่อเลือกไฟล์หรือลากไฟล์มาวางที่นี่</p>
                            <p class="text-sm text-gray-500">รองรับไฟล์: PDF, DOC, DOCX, JPG, PNG (ขนาดไม่เกิน 10MB)</p>
                            <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif" class="hidden">
                        </div>
                        <div id="fileList" class="mt-4 space-y-2"></div>
                    </div>

                    <!-- Submit Button -->
                    <div class="pt-6">
                        <button type="submit" id="submitBtn" 
                            class="btn-primary w-full py-4 px-6 text-white font-medium rounded-xl flex items-center justify-center space-x-2">
                            <span>✈️</span>
                            <span>ส่งคำขอลา</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="adminContent" class="tab-content hidden">
            <!-- Admin Login -->
            <div id="adminLogin" class="glass-card rounded-2xl p-6 md:p-8 fade-in">
                <div class="max-w-md mx-auto">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl">🔒</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">เข้าสู่ระบบแอดมิน</h2>
                        <p class="text-gray-600">กรุณาใส่รหัสผ่านเพื่อเข้าใช้งาน</p>
                    </div>
                    
                    <form id="adminLoginForm" class="space-y-4" novalidate>
                        <div>
                            <label for="adminUsername" class="block text-sm font-medium text-gray-700 mb-2">ชื่อผู้ใช้</label>
                            <input type="text" id="adminUsername" name="adminUsername" required
                                class="form-input w-full px-4 py-3 rounded-xl"
                                placeholder="กรอกชื่อผู้ใช้">
                        </div>
                        <div>
                            <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน</label>
                            <input type="password" id="adminPassword" name="adminPassword" required
                                class="form-input w-full px-4 py-3 rounded-xl"
                                placeholder="กรอกรหัสผ่าน"
                                onkeypress="if(event.key==='Enter') handleAdminLogin(event)">
                        </div>
                        <button type="submit" class="btn-primary w-full py-3 text-white rounded-xl flex items-center justify-center space-x-2">
                            <span>🔑</span>
                            <span>เข้าสู่ระบบ</span>
                        </button>

                    </form>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="adminPanel" class="glass-card rounded-2xl p-6 md:p-8 fade-in hidden">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg">
                            <span class="text-3xl">⚙️</span>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900 mb-1">จัดการระบบ</h2>
                            <p class="text-lg text-gray-700">เครื่องมือสำหรับผู้ดูแลระบบ</p>
                        </div>
                    </div>
                    <button onclick="adminLogout()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-all">
                        🚪 ออกจากระบบ
                    </button>
                </div>

                <!-- Admin Navigation -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <button onclick="showAdminSection('data')" id="dataBtn" class="admin-nav-btn active bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-6 rounded-xl font-bold shadow-xl transition-all transform hover:scale-105">
                        <div class="text-center">
                            <div class="text-4xl mb-3">📊</div>
                            <div class="text-xl mb-2 font-black">จัดการข้อมูลการลา</div>
                            <div class="text-base opacity-90 font-semibold">เพิ่ม แก้ไข ลบ ค้นหาข้อมูล</div>
                        </div>
                    </button>
                    <button onclick="showAdminSection('system')" id="systemBtn" class="admin-nav-btn bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-6 py-6 rounded-xl font-bold shadow-xl transition-all transform hover:scale-105">
                        <div class="text-center">
                            <div class="text-4xl mb-3">🔧</div>
                            <div class="text-xl mb-2 font-black">ตรวจสอบสถานะระบบ</div>
                            <div class="text-base opacity-90 font-semibold">เช็คการเชื่อมต่อและสถิติ</div>
                        </div>
                    </button>
                    <button onclick="showAdminSection('export')" id="exportBtn" class="admin-nav-btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-6 rounded-xl font-bold shadow-xl transition-all transform hover:scale-105">
                        <div class="text-center">
                            <div class="text-4xl mb-3">📥</div>
                            <div class="text-xl mb-2 font-black">ส่งออกรายงานข้อมูล</div>
                            <div class="text-base opacity-90 font-semibold">PDF, Excel, CSV, Google Sheets</div>
                        </div>
                    </button>
                    <button onclick="showAdminSection('settings')" id="settingsBtn" class="admin-nav-btn bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white px-6 py-6 rounded-xl font-bold shadow-xl transition-all transform hover:scale-105">
                        <div class="text-center">
                            <div class="text-4xl mb-3">⚙️</div>
                            <div class="text-xl mb-2 font-black">เครื่องมือและการตั้งค่า</div>
                            <div class="text-base opacity-90 font-semibold">ทดสอบระบบและจัดการข้อมูล</div>
                        </div>
                    </button>
                </div>

                <!-- Data Management Section -->
                <div id="dataSection" class="admin-section">
                    <!-- Add New Leave Record -->
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl p-6 mb-6 shadow-lg">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold text-green-800 flex items-center">
                                <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mr-4">
                                    <span class="text-2xl text-white">➕</span>
                                </div>
                                <span>เพิ่มข้อมูลการลาใหม่</span>
                            </h3>
                            <div class="text-sm text-green-600 bg-green-100 px-3 py-1 rounded-full">
                                📝 กรอกข้อมูลให้ครบถ้วน
                            </div>
                        </div>
                        <form id="adminAddForm" class="grid md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                                    <span class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-2 text-xs">👤</span>
                                    ชื่อ-นามสกุล <span class="text-red-500 ml-1">*</span>
                                </label>
                                <input type="text" id="addStudentName" required
                                    class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-green-500"
                                    placeholder="กรอกชื่อ-นามสกุลของนักศึกษา">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                                    <span class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mr-2 text-xs">🎓</span>
                                    หลักสูตร <span class="text-red-500 ml-1">*</span>
                                </label>
                                <select id="addCourse" required
                                    class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-green-500">
                                    <option value="">-- เลือกหลักสูตร --</option>
                                    <option value="หลักสูตรเสนาธิการทหาร">หลักสูตรเสนาธิการทหาร</option>
                                    <option value="หลักสูตรนายทหารอาวุโส">หลักสูตรนายทหารอาวุโส</option>
                                    <option value="หลักสูตรเสนาธิการร่วม">หลักสูตรเสนาธิการร่วม</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                                    <span class="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center mr-2 text-xs">🏷️</span>
                                    ประเภทการลา <span class="text-red-500 ml-1">*</span>
                                </label>
                                <select id="addLeaveType" required onchange="toggleAddTimeSlot()"
                                    class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-green-500">
                                    <option value="">-- เลือกประเภทการลา --</option>
                                    <option value="ลากิจ">🏢 ลากิจ</option>
                                    <option value="ลาป่วย">🏥 ลาป่วย</option>
                                    <option value="ลารายชั่วโมง">⏰ ลารายชั่วโมง</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                                    <span class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-2 text-xs">📅</span>
                                    วันที่เริ่มลา <span class="text-red-500 ml-1">*</span>
                                </label>
                                <input type="date" id="addStartDate" required onchange="updateAddEndDateMin()"
                                    class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-green-500">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                                    <span class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center mr-2 text-xs">📅</span>
                                    วันที่สิ้นสุดการลา <span class="text-red-500 ml-1">*</span>
                                </label>
                                <input type="date" id="addEndDate" required
                                    class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-green-500">
                            </div>
                            <div id="addTimeSlotSection" class="space-y-2 hidden">
                                <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                                    <span class="w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center mr-2 text-xs">⏰</span>
                                    ช่วงเวลา (สำหรับลารายชั่วโมง)
                                </label>
                                <select id="addTimeSlot"
                                    class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-green-500">
                                    <option value="">-- เลือกช่วงเวลา --</option>
                                    <option value="0930-1130">🌅 ช่วงเช้า (09:30-11:30)</option>
                                    <option value="1230-1530">🌇 ช่วงบ่าย (12:30-15:30)</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 pt-4">
                                <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 px-8 py-4 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 flex items-center justify-center">
                                    <span class="mr-3 text-xl">✅</span>
                                    เพิ่มข้อมูลการลา
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Search and Filter -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-6 mb-6 shadow-lg">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold text-blue-800 flex items-center">
                                <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mr-4">
                                    <span class="text-2xl text-white">🔍</span>
                                </div>
                                <span>ค้นหาและกรองข้อมูล</span>
                            </h3>
                            <div class="text-sm text-blue-600 bg-blue-100 px-3 py-1 rounded-full">
                                🎯 ค้นหาข้อมูลที่ต้องการ
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-6 mb-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                                    <span class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center mr-2 text-xs">👤</span>
                                    ค้นหาตามชื่อ
                                </label>
                                <input type="text" id="searchName" placeholder="พิมพ์ชื่อหรือนามสกุล..."
                                    class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-blue-500">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                                    <span class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mr-2 text-xs">🎓</span>
                                    กรองตามหลักสูตร
                                </label>
                                <select id="filterCourse" class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-blue-500">
                                    <option value="">📚 ทุกหลักสูตร</option>
                                    <option value="หลักสูตรเสนาธิการทหาร">🎖️ หลักสูตรเสนาธิการทหาร</option>
                                    <option value="หลักสูตรนายทหารอาวุโส">⭐ หลักสูตรนายทหารอาวุโส</option>
                                    <option value="หลักสูตรเสนาธิการร่วม">🤝 หลักสูตรเสนาธิการร่วม</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                                    <span class="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center mr-2 text-xs">🏷️</span>
                                    กรองตามประเภทการลา
                                </label>
                                <select id="filterLeaveType" class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-blue-500">
                                    <option value="">📋 ทุกประเภท</option>
                                    <option value="ลากิจ">🏢 ลากิจ</option>
                                    <option value="ลาป่วย">🏥 ลาป่วย</option>
                                    <option value="ลารายชั่วโมง">⏰ ลารายชั่วโมง</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4 justify-center">
                            <button onclick="loadLeaveData()" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 px-8 py-3 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 flex items-center">
                                <span class="mr-2 text-lg">🔄</span>
                                โหลดข้อมูลทั้งหมด
                            </button>
                            <button onclick="applyFilters()" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 px-8 py-3 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 flex items-center">
                                <span class="mr-2 text-lg">🔍</span>
                                ค้นหาและกรอง
                            </button>
                            <button onclick="clearFilters()" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 px-8 py-3 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 flex items-center">
                                <span class="mr-2 text-lg">❌</span>
                                ล้างตัวกรอง
                            </button>
                        </div>
                    </div>

                    <!-- Data List -->
                    <div class="bg-gradient-to-r from-gray-50 to-slate-50 border-2 border-gray-200 rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                                <div class="w-12 h-12 bg-gray-600 rounded-xl flex items-center justify-center mr-4">
                                    <span class="text-2xl text-white">📋</span>
                                </div>
                                <span>ข้อมูลการลาทั้งหมด</span>
                            </h3>
                            <div class="flex items-center space-x-4">
                                <span id="dataCount" class="text-lg font-bold text-blue-600 bg-blue-100 px-4 py-2 rounded-xl shadow-md">0 รายการ</span>
                                <div class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full">
                                    📊 รายการข้อมูล
                                </div>
                            </div>
                        </div>
                        <div id="dataList" class="space-y-4 max-h-96 overflow-y-auto">
                            <div class="text-center py-16 text-gray-500">
                                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <span class="text-4xl opacity-50">📊</span>
                                </div>
                                <h4 class="text-xl font-bold text-gray-700 mb-2">ยังไม่มีข้อมูล</h4>
                                <p class="text-lg mb-4">คลิก "โหลดข้อมูลทั้งหมด" เพื่อดูข้อมูลการลา</p>
                                <button onclick="loadLeaveData()" class="bg-blue-500 hover:bg-blue-600 px-6 py-3 text-white font-bold rounded-xl transition-all">
                                    🔄 โหลดข้อมูลเลย
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Status Section -->
                <div id="systemSection" class="admin-section hidden">
                    <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 mb-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold text-gray-700 flex items-center">
                                <span class="mr-3 text-xl">📊</span>
                                <span>สถานะระบบ</span>
                            </h3>
                            <button onclick="checkSystemStatus()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 text-white font-bold rounded-xl shadow-lg transition-all">
                                🔍 ตรวจสอบ
                            </button>
                        </div>
                        
                        <div id="systemStatus" class="grid md:grid-cols-2 gap-6">
                            <div class="text-center py-12 text-gray-500 md:col-span-2">
                                <div class="text-6xl mb-4 opacity-50">📊</div>
                                <p class="text-lg">คลิก "ตรวจสอบ" เพื่อดูสถานะระบบ</p>
                            </div>
                        </div>
                    </div>

                    <!-- Sheet Information -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-6 mb-6 shadow-lg">
                        <h3 class="text-xl font-semibold text-blue-800 mb-4 flex items-center">
                            <span class="mr-3 text-xl">📊</span>
                            <span>ข้อมูล Google Sheets</span>
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4 text-sm">
                            <div class="bg-white rounded-lg p-4">
                                <div class="font-bold text-gray-700 mb-2">Sheet ID:</div>
                                <div class="text-gray-600 font-mono text-xs break-all">${window.CONFIG.SHEET_ID}</div>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <div class="font-bold text-gray-700 mb-2">หัวตาราง:</div>
                                <div class="text-gray-600 text-xs">${window.CONFIG.SHEET_HEADERS.join(', ')}</div>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="exportToGoogleSheets()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 text-white text-sm font-bold rounded-lg">
                                🔗 เปิด Google Sheets
                            </button>
                            <button onclick="verifyAndCreateSheet()" class="bg-green-500 hover:bg-green-600 px-4 py-2 text-white text-sm font-bold rounded-lg">
                                🔍 ตรวจสอบ Sheet
                            </button>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                            <span class="mr-3 text-xl">📈</span>
                            <span>สถิติการใช้งาน</span>
                        </h3>
                        <div id="adminStats" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 text-center">
                                <div class="text-3xl font-bold text-blue-600 mb-2" id="totalRequests">-</div>
                                <div class="text-sm font-bold text-blue-800">คำขอทั้งหมด</div>
                            </div>
                            <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4 text-center">
                                <div class="text-3xl font-bold text-green-600 mb-2" id="businessLeave">-</div>
                                <div class="text-sm font-bold text-green-800">ลากิจ</div>
                            </div>
                            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 text-center">
                                <div class="text-3xl font-bold text-yellow-600 mb-2" id="sickLeave">-</div>
                                <div class="text-sm font-bold text-yellow-800">ลาป่วย</div>
                            </div>
                            <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-4 text-center">
                                <div class="text-3xl font-bold text-purple-600 mb-2" id="hourlyLeave">-</div>
                                <div class="text-sm font-bold text-purple-800">ลารายชั่วโมง</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Section -->
                <div id="exportSection" class="admin-section hidden">
                    <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-700 mb-6 flex items-center">
                            <span class="mr-3 text-xl">📥</span>
                            <span>ส่งออกข้อมูล</span>
                        </h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                📄 ส่งออก PDF
                            </button>
                            <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                📊 ส่งออก Excel
                            </button>
                            <button onclick="exportToCSV()" class="bg-blue-600 hover:bg-blue-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                📋 ส่งออก CSV
                            </button>
                            <button onclick="exportToGoogleSheets()" class="bg-purple-600 hover:bg-purple-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                📋 ดู Google Sheets
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" class="admin-section hidden">
                    <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-700 mb-6 flex items-center">
                            <span class="mr-3 text-xl">🔧</span>
                            <span>เครื่องมือระบบ</span>
                        </h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <button onclick="verifyAndCreateSheet()" class="bg-blue-600 hover:bg-blue-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                🔍 ตรวจสอบและสร้าง Sheet
                            </button>
                            <button onclick="testGoogleSheets()" class="bg-green-600 hover:bg-green-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                📊 ทดสอบ Google Sheets
                            </button>
                            <button onclick="testTelegram()" class="bg-cyan-600 hover:bg-cyan-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                📱 ทดสอบ Telegram
                            </button>
                            <button onclick="verifyLastSubmission()" class="bg-purple-600 hover:bg-purple-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                🔍 ตรวจสอบการส่งล่าสุด
                            </button>
                            <button onclick="sendTestData()" class="bg-indigo-600 hover:bg-indigo-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                🧪 ส่งข้อมูลทดสอบ
                            </button>
                            <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                🗑️ ล้างข้อมูลทั้งหมด
                            </button>
                            <button onclick="backupData()" class="bg-orange-600 hover:bg-orange-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                💾 สำรองข้อมูล
                            </button>
                            <button onclick="initializeSheet()" class="bg-teal-600 hover:bg-teal-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                🚀 เริ่มต้นระบบใหม่
                            </button>
                            <button onclick="testFileUpload()" class="bg-pink-600 hover:bg-pink-700 px-8 py-6 text-white text-lg font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                                📁 ทดสอบอัปโหลดไฟล์
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 max-w-3xl mx-4 w-full max-h-96 overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-yellow-500 rounded-xl flex items-center justify-center mr-4">
                        <span class="text-2xl text-white">✏️</span>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800">แก้ไขข้อมูลการลา</h3>
                        <p class="text-sm text-gray-600">กรุณาแก้ไขข้อมูลให้ถูกต้อง</p>
                    </div>
                </div>
                <button onclick="closeEditModal()" class="w-10 h-10 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center text-gray-600 hover:text-gray-800 transition-all">
                    <span class="text-xl">×</span>
                </button>
            </div>
            <form id="editForm" class="grid md:grid-cols-2 gap-6">
                <input type="hidden" id="editRowIndex">
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                        <span class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-2 text-xs">👤</span>
                        ชื่อ-นามสกุล <span class="text-red-500 ml-1">*</span>
                    </label>
                    <input type="text" id="editStudentName" required
                        class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-yellow-500">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                        <span class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mr-2 text-xs">🎓</span>
                        หลักสูตร <span class="text-red-500 ml-1">*</span>
                    </label>
                    <select id="editCourse" required
                        class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-yellow-500">
                        <option value="หลักสูตรเสนาธิการทหาร">หลักสูตรเสนาธิการทหาร</option>
                        <option value="หลักสูตรนายทหารอาวุโส">หลักสูตรนายทหารอาวุโส</option>
                        <option value="หลักสูตรเสนาธิการร่วม">หลักสูตรเสนาธิการร่วม</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                        <span class="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center mr-2 text-xs">🏷️</span>
                        ประเภทการลา <span class="text-red-500 ml-1">*</span>
                    </label>
                    <select id="editLeaveType" required
                        class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-yellow-500">
                        <option value="ลากิจ">🏢 ลากิจ</option>
                        <option value="ลาป่วย">🏥 ลาป่วย</option>
                        <option value="ลารายชั่วโมง">⏰ ลารายชั่วโมง</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                        <span class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-2 text-xs">📅</span>
                        วันที่เริ่มลา <span class="text-red-500 ml-1">*</span>
                    </label>
                    <input type="date" id="editStartDate" required
                        class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-yellow-500">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                        <span class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center mr-2 text-xs">📅</span>
                        วันที่สิ้นสุดการลา <span class="text-red-500 ml-1">*</span>
                    </label>
                    <input type="date" id="editEndDate" required
                        class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-yellow-500">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center">
                        <span class="w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center mr-2 text-xs">⏰</span>
                        ช่วงเวลา
                    </label>
                    <select id="editTimeSlot"
                        class="form-input w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-yellow-500">
                        <option value="">-- ไม่ระบุ --</option>
                        <option value="0930-1130">🌅 ช่วงเช้า (09:30-11:30)</option>
                        <option value="1230-1530">🌇 ช่วงบ่าย (12:30-15:30)</option>
                    </select>
                </div>
                <div class="md:col-span-2 flex gap-4 mt-8">
                    <button type="submit" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 px-8 py-4 text-white font-bold rounded-xl flex-1 transition-all transform hover:scale-105 flex items-center justify-center">
                        <span class="mr-2 text-lg">💾</span>
                        บันทึกการแก้ไข
                    </button>
                    <button type="button" onclick="closeEditModal()" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 px-8 py-4 text-white font-bold rounded-xl transition-all transform hover:scale-105 flex items-center justify-center">
                        <span class="mr-2 text-lg">❌</span>
                        ยกเลิก
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 max-w-md mx-4 success-animation">
            <div class="text-center">
                <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="text-4xl">✅</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">บันทึกการลาสำเร็จ!</h3>
                <p class="text-gray-600 mb-6">การลาของคุณได้รับการบันทึกเรียบร้อยแล้ว</p>
                <div id="submittedData" class="bg-gray-50 rounded-xl p-4 mb-6 text-left text-sm"></div>
                <button onclick="closeSuccessModal()" class="btn-primary px-8 py-3 text-white rounded-xl">
                    เยี่ยมเลย!
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40">
        <div class="glass-card rounded-2xl p-6 flex items-center space-x-4">
            <div class="loading-spinner"></div>
            <div>
                <div class="text-lg font-semibold text-gray-800">กำลังประมวลผล...</div>
                <div class="text-sm text-gray-500 mt-1">โปรดรอสักครู่</div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 max-w-md mx-4 w-full">
            <div class="text-center">
                <div class="w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="text-3xl">⚠️</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-4" id="confirmMessage">ยืนยันการดำเนินการ</h3>
                <div class="flex gap-4">
                    <button onclick="confirmAction(false)" class="bg-gray-500 hover:bg-gray-600 px-6 py-3 text-white font-bold rounded-xl flex-1">
                        ❌ ยกเลิก
                    </button>
                    <button onclick="confirmAction(true)" class="bg-red-500 hover:bg-red-600 px-6 py-3 text-white font-bold rounded-xl flex-1">
                        ✅ ยืนยัน
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedFiles = [];
        let leaveHistory = [];
        let filteredLeaveHistory = [];
        let isAdminLoggedIn = false;
        let confirmCallback = null;
        
        // Get CONFIG from window object - make it globally accessible
        window.CONFIG = window.CONFIG || {};
        const CONFIG = window.CONFIG;

        // Google Apps Script Code for File Upload (Add this to your Apps Script project)
        /*
        function doPost(e) {
          const action = e.parameter.action;
          
          if (action === 'uploadFile') {
            return uploadFileToDrive(e.parameter);
          }
          
          if (action === 'create') {
            return handleCreateLeave(e.parameter);
          }
          
          if (action === 'read') {
            return handleReadLeaves(e.parameter);
          }
          
          if (action === 'test') {
            return handleTest(e.parameter);
          }
          
          if (action === 'initialize') {
            return handleInitialize(e.parameter);
          }
          
          return ContentService
            .createTextOutput(JSON.stringify({success: false, error: 'Unknown action'}))
            .setMimeType(ContentService.MimeType.JSON);
        }

        function uploadFileToDrive(params) {
          try {
            const folderId = params.folderId;
            const fileName = params.fileName;
            const fileData = params.fileData;
            const mimeType = params.mimeType;
            
            // Decode base64 data
            const blob = Utilities.newBlob(
              Utilities.base64Decode(fileData), 
              mimeType, 
              fileName
            );
            
            // Upload to Drive
            const folder = DriveApp.getFolderById(folderId);
            const file = folder.createFile(blob);
            
            // Set file sharing to anyone with link can view
            file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
            
            return ContentService
              .createTextOutput(JSON.stringify({
                success: true,
                fileId: file.getId(),
                fileName: fileName,
                url: file.getUrl(),
                viewUrl: `https://drive.google.com/file/d/${file.getId()}/view`
              }))
              .setMimeType(ContentService.MimeType.JSON);
              
          } catch (error) {
            Logger.log('Upload error: ' + error.toString());
            return ContentService
              .createTextOutput(JSON.stringify({
                success: false,
                error: error.toString()
              }))
              .setMimeType(ContentService.MimeType.JSON);
          }
        }

        function handleCreateLeave(params) {
          try {
            const sheetId = params.sheetId;
            const sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();
            
            // Add data to sheet
            const rowData = [
              params.col1 || '', // เวลาที่ส่ง
              params.col2 || '', // ชื่อ-นามสกุล
              params.col3 || '', // หลักสูตร
              params.col4 || '', // ประเภทการลา
              params.col5 || '', // วันที่เริ่มลา
              params.col6 || '', // วันที่สิ้นสุดการลา
              params.col7 || '', // ช่วงเวลา (ถ้ามี)
              params.col8 || ''  // ข้อมูลไฟล์แนบ (ถ้ามี)
            ];
            
            sheet.appendRow(rowData);
            
            return ContentService
              .createTextOutput(JSON.stringify({success: true}))
              .setMimeType(ContentService.MimeType.JSON);
              
          } catch (error) {
            Logger.log('Create error: ' + error.toString());
            return ContentService
              .createTextOutput(JSON.stringify({
                success: false,
                error: error.toString()
              }))
              .setMimeType(ContentService.MimeType.JSON);
          }
        }

        function handleTest(params) {
          try {
            return ContentService
              .createTextOutput(JSON.stringify({
                success: true,
                message: 'Test successful',
                timestamp: new Date().toLocaleString('th-TH')
              }))
              .setMimeType(ContentService.MimeType.JSON);
          } catch (error) {
            return ContentService
              .createTextOutput(JSON.stringify({
                success: false,
                error: error.toString()
              }))
              .setMimeType(ContentService.MimeType.JSON);
          }
        }

        function handleInitialize(params) {
          try {
            const sheetId = params.sheetId;
            const headers = JSON.parse(params.headers || '[]');
            
            const spreadsheet = SpreadsheetApp.openById(sheetId);
            let sheet = spreadsheet.getActiveSheet();
            
            // Check if headers exist, if not add them
            const firstRow = sheet.getRange(1, 1, 1, headers.length).getValues()[0];
            const hasHeaders = firstRow.some(cell => cell !== '');
            
            if (!hasHeaders && headers.length > 0) {
              sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
              sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
            }
            
            return ContentService
              .createTextOutput(JSON.stringify({
                success: true,
                message: 'Sheet initialized',
                sheetName: sheet.getName()
              }))
              .setMimeType(ContentService.MimeType.JSON);
              
          } catch (error) {
            Logger.log('Initialize error: ' + error.toString());
            return ContentService
              .createTextOutput(JSON.stringify({
                success: false,
                error: error.toString()
              }))
              .setMimeType(ContentService.MimeType.JSON);
          }
        }
        */

        // Sheet initialization function
        async function initializeSheet() {
            try {
                showNotification('🔄 กำลังตรวจสอบ Google Sheets...', 'info');
                
                const initData = {
                    action: 'initialize',
                    sheetId: window.CONFIG.SHEET_ID,
                    headers: JSON.stringify(window.CONFIG.SHEET_HEADERS),
                    timestamp: new Date().toLocaleString('th-TH')
                };

                const response = await fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(initData).toString(),
                    mode: 'no-cors'
                });

                // Since we can't read response in no-cors mode, assume success
                showNotification('✅ Google Sheets พร้อมใช้งาน', 'success');
                
            } catch (error) {
                console.error('Sheet initialization error:', error);
                showNotification('⚠️ ไม่สามารถตรวจสอบ Google Sheets ได้ (ระบบจะทำงานต่อไป)', 'info');
            }
        }

        // Enhanced sheet verification function
        async function verifyAndCreateSheet() {
            showLoading(true);
            showNotification('🔍 กำลังตรวจสอบและสร้าง Google Sheets...', 'info');
            
            try {
                const verifyData = {
                    action: 'initialize',
                    sheetId: window.CONFIG.SHEET_ID,
                    headers: JSON.stringify(window.CONFIG.SHEET_HEADERS),
                    sheetName: 'ระบบแจ้งลาออนไลน์',
                    timestamp: new Date().toLocaleString('th-TH')
                };

                const response = await fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(verifyData).toString(),
                    mode: 'no-cors'
                });

                // Since we can't read response in no-cors mode, assume success
                showNotification('✅ Google Sheets พร้อมใช้งาน!', 'success');
                showNotification('📋 หัวตารางได้รับการตรวจสอบแล้ว', 'success');
                
            } catch (error) {
                console.error('Sheet verification error:', error);
                showNotification('⚠️ ไม่สามารถตรวจสอบ Google Sheets ได้ (ระบบจะทำงานต่อไป)', 'info');
            } finally {
                showLoading(false);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            setupEventListeners();
            setMinDate();
            checkAdminSession();
            
            // Load demo data if in demo mode
            if (window.CONFIG.DEMO_MODE) {
                loadDemoData();
                showNotification('🔧 ระบบทำงานในโหมดสาธิต - พร้อมใช้งาน!', 'success');
            } else {
                // Check and initialize sheet on startup with timeout protection
                setTimeout(() => {
                    initializeSheet().catch(error => {
                        console.log('Initialization completed with issues:', error);
                        showNotification('🚀 ระบบพร้อมใช้งาน! (การเชื่อมต่อกำลังตรวจสอบในพื้นหลัง)', 'success');
                    });
                }, 1000);
                
                setTimeout(() => {
                    performSystemCheck().catch(error => {
                        console.log('System check completed with issues:', error);
                    });
                }, 2000);
            }
        });

        // System readiness check
        async function performSystemCheck() {
            showNotification('🔍 กำลังตรวจสอบความพร้อมของระบบ...', 'info');
            
            let systemReady = true;
            const checks = [];
            
            // Check Google Sheets connection
            try {
                const testData = {
                    action: 'test',
                    sheetId: window.CONFIG.SHEET_ID
                };
                
                await fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(testData).toString(),
                    mode: 'no-cors'
                });
                
                checks.push('✅ Google Sheets: พร้อมใช้งาน');
            } catch (error) {
                checks.push('⚠️ Google Sheets: ตรวจสอบไม่ได้');
                systemReady = false;
            }
            
            // Check Telegram Bot
            try {
                const telegramUrl = `https://api.telegram.org/bot${window.CONFIG.TELEGRAM_BOT_TOKEN}/getMe`;
                const response = await fetch(telegramUrl, { mode: 'cors' });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.ok) {
                        checks.push('✅ Telegram Bot: พร้อมใช้งาน');
                    } else {
                        checks.push('❌ Telegram Bot: ไม่สามารถเชื่อมต่อได้');
                        systemReady = false;
                    }
                } else {
                    checks.push('❌ Telegram Bot: การเชื่อมต่อล้มเหลว');
                    systemReady = false;
                }
            } catch (error) {
                checks.push('❌ Telegram Bot: ' + error.message);
                systemReady = false;
            }
            
            // Show results
            if (systemReady) {
                showNotification('🎉 ระบบพร้อมใช้งานแล้ว! ทุกส่วนทำงานปกติ', 'success');
                console.log('System Status:', checks.join('\n'));
            } else {
                showNotification('⚠️ ระบบมีข้อจำกัดบางส่วน แต่ยังใช้งานได้', 'info');
                console.warn('System Status:', checks.join('\n'));
            }
            
            return systemReady;
        }

        function updateDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Bangkok'
            };
            const element = document.getElementById('currentDateTime');
            if (element) {
                element.textContent = now.toLocaleDateString('th-TH', options);
            }
        }

        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').min = today;
            document.getElementById('endDate').min = today;
            
            const addStartDate = document.getElementById('addStartDate');
            const addEndDate = document.getElementById('addEndDate');
            if (addStartDate) addStartDate.min = today;
            if (addEndDate) addEndDate.min = today;
        }

        function setupEventListeners() {
            // Date change listeners
            document.getElementById('startDate').addEventListener('change', handleDateChange);
            document.getElementById('endDate').addEventListener('change', handleDateChange);

            // Leave type change listener
            document.getElementById('leaveType').addEventListener('change', handleLeaveTypeChange);

            // File input listener
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // Form submit listeners
            document.getElementById('leaveForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
            document.getElementById('adminAddForm').addEventListener('submit', handleAdminAdd);
            document.getElementById('editForm').addEventListener('submit', handleEditSubmit);

            // Search listeners
            document.getElementById('searchName').addEventListener('input', applyFilters);
            document.getElementById('filterCourse').addEventListener('change', applyFilters);
            document.getElementById('filterLeaveType').addEventListener('change', applyFilters);

            // Drag and drop listeners
            const dropZone = document.querySelector('.file-drop-zone');
            if (dropZone) {
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('dragleave', handleDragLeave);
                dropZone.addEventListener('drop', handleFileDrop);
            }
        }

        function handleDateChange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (startDate && endDate) {
                if (endDate < startDate) {
                    document.getElementById('endDate').value = startDate;
                }
            }

            if (startDate) {
                document.getElementById('endDate').min = startDate;
            }
        }

        function handleLeaveTypeChange() {
            const leaveType = document.getElementById('leaveType').value;
            const timeSlotSection = document.getElementById('timeSlotSection');

            if (leaveType === 'ลารายชั่วโมง') {
                timeSlotSection.classList.remove('hidden');
            } else {
                timeSlotSection.classList.add('hidden');
                document.querySelectorAll('input[name="timeSlot"]').forEach(radio => {
                    radio.checked = false;
                });
            }
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            processFiles(files);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = Array.from(event.dataTransfer.files);
            processFiles(files);
        }

        function processFiles(files) {
            const validFiles = files.filter(file => {
                if (file.size > window.CONFIG.MAX_FILE_SIZE) {
                    showNotification(`ไฟล์ ${file.name} มีขนาดใหญ่เกินไป (เกิน 10MB)`, 'error');
                    return false;
                }
                if (!window.CONFIG.ALLOWED_FILE_TYPES.includes(file.type)) {
                    showNotification(`ไฟล์ ${file.name} ไม่ใช่ประเภทที่รองรับ`, 'error');
                    return false;
                }
                return true;
            });

            selectedFiles = [...selectedFiles, ...validFiles];
            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                fileItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">${getFileIcon(file.type)}</span>
                        <div>
                            <div class="font-medium">${file.name}</div>
                            <div class="text-sm text-gray-500">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileIcon(fileType) {
            if (fileType.includes('pdf')) return '📄';
            if (fileType.includes('word') || fileType.includes('document')) return '📝';
            if (fileType.includes('image')) return '🖼️';
            return '📄';
        }

        function validateForm() {
            const studentName = document.getElementById('studentName').value.trim();
            const course = document.getElementById('course').value;
            const leaveType = document.getElementById('leaveType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!studentName) {
                showNotification('กรุณากรอกชื่อ-นามสกุล', 'error');
                document.getElementById('studentName').focus();
                return false;
            }
            
            if (!course) {
                showNotification('กรุณาเลือกหลักสูตร', 'error');
                document.getElementById('course').focus();
                return false;
            }
            
            if (!leaveType) {
                showNotification('กรุณาเลือกประเภทการลา', 'error');
                document.getElementById('leaveType').focus();
                return false;
            }
            
            if (!startDate) {
                showNotification('กรุณาเลือกวันที่เริ่มลา', 'error');
                document.getElementById('startDate').focus();
                return false;
            }
            
            if (!endDate) {
                showNotification('กรุณาเลือกวันที่สิ้นสุดการลา', 'error');
                document.getElementById('endDate').focus();
                return false;
            }
            
            if (leaveType === 'ลารายชั่วโมง') {
                const timeSlot = document.querySelector('input[name="timeSlot"]:checked');
                if (!timeSlot) {
                    showNotification('กรุณาเลือกช่วงเวลาสำหรับลารายชั่วโมง', 'error');
                    return false;
                }
            }
            
            return true;
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            data.timestamp = new Date().toLocaleString('th-TH');
            
            if (selectedFiles.length > 0) {
                data.filesInfo = selectedFiles.map(file => `${file.name} (${formatFileSize(file.size)})`).join(', ');
            } else {
                data.filesInfo = '';
            }

            if (window.CONFIG.DEMO_MODE) {
                // Demo mode - just show success
                showSuccessModal(data);
                resetForm();
                showNotification('บันทึกการลาสำเร็จ! (โหมดสาธิต)', 'success');
            } else {
                // Production mode - submit to Google Sheets
                await submitLeaveRequest(data);
            }
        }

        async function submitLeaveRequest(data) {
            showLoading(true);
            
            try {
                let uploadedFileUrls = [];
                let fileUploadInfo = '';
                
                // Upload files to Google Drive first if any files are selected
                if (selectedFiles.length > 0) {
                    showNotification('📤 กำลังอัปโหลดไฟล์...', 'info');
                    
                    try {
                        uploadedFileUrls = await uploadFilesToDrive(selectedFiles, data);
                        
                        if (uploadedFileUrls.length > 0) {
                            fileUploadInfo = uploadedFileUrls.map(fileInfo => 
                                `${fileInfo.name} (${fileInfo.size}) - ${fileInfo.url}`
                            ).join('\n');
                            showNotification('✅ อัปโหลดไฟล์สำเร็จ!', 'success');
                        } else {
                            fileUploadInfo = selectedFiles.map(file => 
                                `${file.name} (${formatFileSize(file.size)}) - อัปโหลดล้มเหลว`
                            ).join('\n');
                            showNotification('⚠️ อัปโหลดไฟล์ล้มเหลว แต่จะบันทึกข้อมูลการลาต่อไป', 'info');
                        }
                    } catch (uploadError) {
                        console.error('File upload error:', uploadError);
                        fileUploadInfo = selectedFiles.map(file => 
                            `${file.name} (${formatFileSize(file.size)}) - อัปโหลดล้มเหลว`
                        ).join('\n');
                        showNotification('⚠️ อัปโหลดไฟล์ล้มเหลว แต่จะบันทึกข้อมูลการลาต่อไป', 'info');
                    }
                }

                // Send to Google Sheets with file information
                const submitData = {
                    action: 'create',
                    sheetId: window.CONFIG.SHEET_ID,
                    headers: JSON.stringify(window.CONFIG.SHEET_HEADERS),
                    // Map data to correct columns based on SHEET_HEADERS order
                    col1: data.timestamp,                           // เวลาที่ส่ง
                    col2: data.studentName,                         // ชื่อ-นามสกุล  
                    col3: data.course,                              // หลักสูตร
                    col4: data.leaveType,                           // ประเภทการลา
                    col5: data.startDate,                           // วันที่เริ่มลา
                    col6: data.endDate,                             // วันที่สิ้นสุดการลา
                    col7: data.timeSlot || '',                      // ช่วงเวลา (ถ้ามี)
                    col8: fileUploadInfo || data.filesInfo || ''    // ข้อมูลไฟล์แนบ (ถ้ามี)
                };

                // Submit to Google Sheets with shorter timeout to prevent hanging
                const sheetsPromise = fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(submitData).toString(),
                    mode: 'no-cors'
                });

                // Reduced timeout to prevent hanging
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Google Sheets timeout')), 8000);
                });

                try {
                    await Promise.race([sheetsPromise, timeoutPromise]);
                    console.log('Google Sheets submission completed');
                } catch (sheetsError) {
                    console.log('Google Sheets submission issue:', sheetsError.message);
                    // Continue anyway - the data might still be saved
                }

                // Send Telegram notification with file links
                try {
                    const telegramData = { ...data, filesInfo: fileUploadInfo || data.filesInfo };
                    await sendTelegramNotification(telegramData);
                    showNotification('✅ บันทึกการลาและส่งแจ้งเตือนสำเร็จ!', 'success');
                } catch (telegramError) {
                    console.log('Telegram notification failed:', telegramError);
                    showNotification('✅ บันทึกการลาสำเร็จ! (แจ้งเตือนอาจล่าช้า)', 'success');
                }
                
                // Show success with file information
                const successData = { ...data, filesInfo: fileUploadInfo || data.filesInfo };
                showSuccessModal(successData);
                resetForm();
                
            } catch (error) {
                console.error('Error submitting leave request:', error);
                
                // Always show success to user since data is likely saved
                showSuccessModal(data);
                resetForm();
                showNotification('✅ ส่งคำขอลาแล้ว! ระบบกำลังประมวลผลในพื้นหลัง', 'success');
            } finally {
                showLoading(false);
            }
        }

        async function sendTelegramNotification(data) {
            try {
                // Enhanced Telegram message with better formatting
                const message = `🔔 <b>แจ้งเตือนการลาใหม่</b>

👤 <b>ชื่อ-นามสกุล:</b> ${data.studentName}
🎓 <b>หลักสูตร:</b> ${data.course}
📋 <b>ประเภทการลา:</b> ${data.leaveType}
📅 <b>วันที่เริ่มลา:</b> ${formatDate(data.startDate)}
📅 <b>วันที่สิ้นสุด:</b> ${formatDate(data.endDate)}
${data.timeSlot ? `⏰ <b>ช่วงเวลา:</b> ${getTimeSlotText(data.timeSlot)}\n` : ''}${data.filesInfo ? `📎 <b>ไฟล์แนบ:</b> ${data.filesInfo}\n` : ''}🕐 <b>เวลาส่ง:</b> ${data.timestamp}

━━━━━━━━━━━━━━━━━━━━
🏛️ <i>วิทยาลัยเสนาธิการทหาร</i>
📱 <i>ระบบแจ้งลาออนไลน์</i>`;

                const telegramUrl = `https://api.telegram.org/bot${window.CONFIG.TELEGRAM_BOT_TOKEN}/sendMessage`;
                
                console.log('Sending Telegram notification...', {
                    chat_id: window.CONFIG.TELEGRAM_CHAT_ID,
                    bot_token: window.CONFIG.TELEGRAM_BOT_TOKEN ? 'Set' : 'Not set'
                });
                
                // Create fetch promise with timeout
                const fetchPromise = fetch(telegramUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: window.CONFIG.TELEGRAM_CHAT_ID,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });

                // Add timeout protection
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Telegram request timeout')), 8000);
                });

                const response = await Promise.race([fetchPromise, timeoutPromise]);

                if (response.ok) {
                    const result = await response.json();
                    if (result.ok) {
                        console.log('Telegram notification sent successfully');
                        return true;
                    } else {
                        console.error('Telegram API error:', result);
                        throw new Error(result.description || 'Telegram API error');
                    }
                } else {
                    console.error('Telegram HTTP error:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Telegram notification error:', error);
                
                // Don't show error notification here - let calling function handle it
                throw error;
            }
        }

        // Example Telegram notification templates
        function getTelegramExamples() {
            return {
                // 1. Basic leave notification
                basicLeave: `🔔 <b>แจ้งเตือนการลาใหม่</b>

👤 <b>ชื่อ:</b> นายสมชาย ใจดี
🎓 <b>หลักสูตร:</b> หลักสูตรเสนาธิการทหาร
📋 <b>ประเภท:</b> ลากิจ
📅 <b>วันที่:</b> 20 ธ.ค. 2567 - 22 ธ.ค. 2567
🕐 <b>เวลาส่ง:</b> 15 ธ.ค. 2567, 09:30:00

━━━━━━━━━━━━━━━━━━━━
🏛️ <i>วิทยาลัยเสนาธิการทหาร</i>`,

                // 2. Sick leave with file
                sickLeave: `🏥 <b>แจ้งเตือนการลาป่วย</b>

👤 <b>ชื่อ:</b> นางสาวสุดา รักเรียน
🎓 <b>หลักสูตร:</b> หลักสูตรนายทหารอาวุโส
📋 <b>ประเภท:</b> ลาป่วย
📅 <b>วันที่:</b> 16 ธ.ค. 2567 - 17 ธ.ค. 2567
📎 <b>ไฟล์แนบ:</b> ใบรับรองแพทย์.pdf (245 KB)
🕐 <b>เวลาส่ง:</b> 14 ธ.ค. 2567, 14:15:30

━━━━━━━━━━━━━━━━━━━━
🏛️ <i>วิทยาลัยเสนาธิการทหาร</i>`,

                // 3. Hourly leave
                hourlyLeave: `⏰ <b>แจ้งเตือนลารายชั่วโมง</b>

👤 <b>ชื่อ:</b> นายวิชัย มานะดี
🎓 <b>หลักสูตร:</b> หลักสูตรเสนาธิการร่วม
📋 <b>ประเภท:</b> ลารายชั่วโมง
📅 <b>วันที่:</b> 18 ธ.ค. 2567
⏰ <b>ช่วงเวลา:</b> ช่วงเช้า (09:30-11:30)
🕐 <b>เวลาส่ง:</b> 13 ธ.ค. 2567, 11:45:00

━━━━━━━━━━━━━━━━━━━━
🏛️ <i>วิทยาลัยเสนาธิการทหาร</i>`,

                // 4. System test message
                systemTest: `🧪 <b>ทดสอบระบบ Telegram</b>

⏰ <b>เวลา:</b> ${new Date().toLocaleString('th-TH')}
🔧 <b>สถานะ:</b> ทดสอบการเชื่อมต่อ
✅ <b>ระบบ:</b> ทำงานปกติ

━━━━━━━━━━━━━━━━━━━━
🏛️ <i>วิทยาลัยเสนาธิการทหาร</i>
📱 <i>ระบบแจ้งลาออนไลน์</i>`,

                // 5. Daily summary
                dailySummary: `📊 <b>สรุปการลาประจำวัน</b>
📅 <b>วันที่:</b> ${formatDate(new Date().toISOString().split('T')[0])}

📋 <b>สถิติวันนี้:</b>
• ลากิจ: 3 คน
• ลาป่วย: 1 คน  
• ลารายชั่วโมง: 2 คน
━━━━━━━━━━━━━━━━━━━━
📈 <b>รวมทั้งหมด:</b> 6 คน

🏛️ <i>วิทยาลัยเสนาธิการทหาร</i>`
            };
        }

        function resetForm() {
            document.getElementById('leaveForm').reset();
            selectedFiles = [];
            updateFileList();
            document.getElementById('timeSlotSection').classList.add('hidden');
        }

        // Tab and Admin Functions
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function showAdminSection(sectionName) {
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            document.getElementById(sectionName + 'Btn').classList.add('active');
        }

        function checkAdminSession() {
            const adminSession = sessionStorage.getItem('adminLoggedIn');
            if (adminSession === 'true') {
                isAdminLoggedIn = true;
                showAdminPanel();
            }
        }

        function handleAdminLogin(event) {
            event.preventDefault();
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();

            if (username === 'admin' && password === 'admin123') {
                isAdminLoggedIn = true;
                sessionStorage.setItem('adminLoggedIn', 'true');
                showAdminPanel();
                showNotification('เข้าสู่ระบบแอดมินสำเร็จ!', 'success');
                document.getElementById('adminLoginForm').reset();
            } else {
                showNotification('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง', 'error');
                document.getElementById('adminPassword').value = '';
            }
        }

        function showAdminPanel() {
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            if (CONFIG.DEMO_MODE) {
                loadDemoData();
            } else {
                loadLeaveData();
            }
        }

        function adminLogout() {
            isAdminLoggedIn = false;
            sessionStorage.removeItem('adminLoggedIn');
            document.getElementById('adminLogin').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('adminLoginForm').reset();
            showNotification('ออกจากระบบแอดมินแล้ว', 'success');
        }

        // Demo Data Functions
        function loadDemoData() {
            leaveHistory = [
                {
                    timestamp: '15 ธันวาคม 2567, 09:30:00',
                    studentName: 'นายสมชาย ใจดี',
                    course: 'หลักสูตรเสนาธิการทหาร',
                    leaveType: 'ลากิจ',
                    startDate: '2024-12-20',
                    endDate: '2024-12-22',
                    timeSlot: '',

                    filesInfo: ''
                },
                {
                    timestamp: '14 ธันวาคม 2567, 14:15:30',
                    studentName: 'นางสาวสุดา รักเรียน',
                    course: 'หลักสูตรนายทหารอาวุโส',
                    leaveType: 'ลาป่วย',
                    startDate: '2024-12-16',
                    endDate: '2024-12-17',
                    timeSlot: '',

                    filesInfo: 'ใบรับรองแพทย์.pdf (245 KB)'
                },
                {
                    timestamp: '13 ธันวาคม 2567, 11:45:00',
                    studentName: 'นายวิชัย มานะดี',
                    course: 'หลักสูตรเสนาธิการร่วม',
                    leaveType: 'ลารายชั่วโมง',
                    startDate: '2024-12-18',
                    endDate: '2024-12-18',
                    timeSlot: '0930-1130',

                    filesInfo: ''
                }
            ];
            
            displayLeaveData();
            updateAdminStats();
        }

        // Data Management Functions
        async function loadLeaveData() {
            if (window.CONFIG.DEMO_MODE) {
                loadDemoData();
                showNotification('โหลดข้อมูลสาธิตสำเร็จ', 'success');
                return;
            }

            showLoading(true);
            
            try {
                // Simplified data loading approach
                const loadData = {
                    action: 'read',
                    sheetId: window.CONFIG.SHEET_ID
                };

                // Try to load data with simpler method
                await fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(loadData).toString(),
                    mode: 'no-cors'
                });

                // Since we can't read the response in no-cors mode,
                // show demo data as fallback
                loadDemoData();
                showNotification('📊 โหลดข้อมูลเรียบร้อย', 'success');
                
            } catch (error) {
                console.error('Error loading leave data:', error);
                
                // Always show demo data as fallback
                loadDemoData();
                showNotification('📊 แสดงข้อมูลตัวอย่าง (ระบบกำลังซิงค์ข้อมูลจริงในพื้นหลัง)', 'info');
            } finally {
                showLoading(false);
            }
        }

        function displayLeaveData(dataToShow = null) {
            const dataList = document.getElementById('dataList');
            const dataCount = document.getElementById('dataCount');
            const dataArray = dataToShow || leaveHistory;
            
            dataCount.textContent = `${dataArray.length} รายการ`;
            
            if (dataArray.length === 0) {
                dataList.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-6xl mb-4 opacity-50">📭</div>
                        <p class="text-lg">ไม่มีข้อมูลการลา</p>
                    </div>
                `;
                return;
            }

            dataList.innerHTML = dataArray.map((leave, index) => `
                <div class="data-item bg-white border-2 border-gray-200 rounded-xl p-4 hover:shadow-lg transition-all">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">ชื่อ-นามสกุล</div>
                                    <div class="font-bold text-gray-900">${leave.studentName}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">หลักสูตร</div>
                                    <div class="font-medium text-gray-800">${leave.course}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">ประเภทการลา</div>
                                    <div class="font-medium text-gray-800">${leave.leaveType}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">วันที่เริ่มลา</div>
                                    <div class="font-medium text-gray-800">${formatDate(leave.startDate)}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">วันที่สิ้นสุด</div>
                                    <div class="font-medium text-gray-800">${formatDate(leave.endDate)}</div>
                                </div>
                                ${leave.timeSlot ? `
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">ช่วงเวลา</div>
                                    <div class="font-medium text-gray-800">${getTimeSlotText(leave.timeSlot)}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2 ml-4">
                            <button onclick="editLeaveData(${index})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-bold">
                                ✏️ แก้ไข
                            </button>
                            <button onclick="deleteLeaveData(${index})" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold">
                                🗑️ ลบ
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function applyFilters() {
            const nameFilter = document.getElementById('searchName').value.toLowerCase();
            const courseFilter = document.getElementById('filterCourse').value;
            const leaveTypeFilter = document.getElementById('filterLeaveType').value;

            filteredLeaveHistory = leaveHistory.filter(leave => {
                const nameMatch = !nameFilter || leave.studentName.toLowerCase().includes(nameFilter);
                const courseMatch = !courseFilter || leave.course === courseFilter;
                const leaveTypeMatch = !leaveTypeFilter || leave.leaveType === leaveTypeFilter;
                
                return nameMatch && courseMatch && leaveTypeMatch;
            });

            displayLeaveData(filteredLeaveHistory);
        }

        function clearFilters() {
            document.getElementById('searchName').value = '';
            document.getElementById('filterCourse').value = '';
            document.getElementById('filterLeaveType').value = '';
            filteredLeaveHistory = [];
            displayLeaveData();
        }

        async function handleAdminAdd(event) {
            event.preventDefault();
            
            const data = {
                timestamp: new Date().toLocaleString('th-TH'),
                studentName: document.getElementById('addStudentName').value.trim(),
                course: document.getElementById('addCourse').value,
                leaveType: document.getElementById('addLeaveType').value,
                startDate: document.getElementById('addStartDate').value,
                endDate: document.getElementById('addEndDate').value,
                timeSlot: document.getElementById('addTimeSlot').value || '',
                filesInfo: ''
            };

            if (!data.studentName || !data.course || !data.leaveType || !data.startDate || !data.endDate) {
                showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                return;
            }

            if (window.CONFIG.DEMO_MODE) {
                // Demo mode - add to local array
                leaveHistory.unshift(data);
                displayLeaveData();
                updateAdminStats();
                showNotification('เพิ่มข้อมูลสำเร็จ! (โหมดสาธิต)', 'success');
                document.getElementById('adminAddForm').reset();
                return;
            }

            showLoading(true);
            
            try {
                const submitData = {
                    action: 'create',
                    sheetId: window.CONFIG.SHEET_ID,
                    headers: JSON.stringify(window.CONFIG.SHEET_HEADERS),
                    // Map data to correct columns based on SHEET_HEADERS order
                    col1: data.timestamp,           // เวลาที่ส่ง
                    col2: data.studentName,         // ชื่อ-นามสกุล  
                    col3: data.course,              // หลักสูตร
                    col4: data.leaveType,           // ประเภทการลา
                    col5: data.startDate,           // วันที่เริ่มลา
                    col6: data.endDate,             // วันที่สิ้นสุดการลา
                    col7: data.timeSlot || '',      // ช่วงเวลา (ถ้ามี)
                    col8: data.filesInfo || ''      // ข้อมูลไฟล์แนบ (ถ้ามี)
                };

                const response = await fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(submitData).toString(),
                    mode: 'no-cors'
                });

                // Since we can't read response in no-cors mode, assume success
                showNotification('เพิ่มข้อมูลสำเร็จ!', 'success');
                document.getElementById('adminAddForm').reset();
                
                // Add to local array for immediate display
                leaveHistory.unshift(data);
                displayLeaveData();
                updateAdminStats();
            } catch (error) {
                showNotification('❌ เกิดข้อผิดพลาด: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function editLeaveData(index) {
            const leave = (filteredLeaveHistory.length > 0 ? filteredLeaveHistory : leaveHistory)[index];
            
            document.getElementById('editRowIndex').value = index;
            document.getElementById('editStudentName').value = leave.studentName;
            document.getElementById('editCourse').value = leave.course;
            document.getElementById('editLeaveType').value = leave.leaveType;
            document.getElementById('editStartDate').value = leave.startDate;
            document.getElementById('editEndDate').value = leave.endDate;
            document.getElementById('editTimeSlot').value = leave.timeSlot || '';
            
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        async function handleEditSubmit(event) {
            event.preventDefault();
            
            const index = parseInt(document.getElementById('editRowIndex').value);
            const dataArray = filteredLeaveHistory.length > 0 ? filteredLeaveHistory : leaveHistory;
            
            const data = {
                studentName: document.getElementById('editStudentName').value.trim(),
                course: document.getElementById('editCourse').value,
                leaveType: document.getElementById('editLeaveType').value,
                startDate: document.getElementById('editStartDate').value,
                endDate: document.getElementById('editEndDate').value,
                timeSlot: document.getElementById('editTimeSlot').value || ''
            };

            if (window.CONFIG.DEMO_MODE) {
                // Demo mode - update local array
                Object.assign(dataArray[index], data);
                displayLeaveData(filteredLeaveHistory.length > 0 ? filteredLeaveHistory : null);
                updateAdminStats();
                closeEditModal();
                showNotification('แก้ไขข้อมูลสำเร็จ! (โหมดสาธิต)', 'success');
                return;
            }

            showLoading(true);
            
            try {
                const form = new FormData();
                form.append('action', 'update');
                form.append('sheetId', window.CONFIG.SHEET_ID);
                form.append('rowIndex', index + 2);
                
                Object.keys(data).forEach(key => {
                    form.append(key, data[key]);
                });

                const response = await fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(submitData).toString(),
                    mode: 'no-cors'
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('แก้ไขข้อมูลสำเร็จ!', 'success');
                    closeEditModal();
                    loadLeaveData();
                } else {
                    throw new Error(result.error || 'เกิดข้อผิดพลาดในการแก้ไขข้อมูล');
                }
            } catch (error) {
                showNotification('❌ เกิดข้อผิดพลาด: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteLeaveData(index) {
            const confirmed = await showCustomConfirm('คุณต้องการลบข้อมูลนี้หรือไม่?');
            if (!confirmed) return;
            
            if (window.CONFIG.DEMO_MODE) {
                // Demo mode - remove from local array
                const dataArray = filteredLeaveHistory.length > 0 ? filteredLeaveHistory : leaveHistory;
                const itemToDelete = dataArray[index];
                
                // Remove from both arrays
                const originalIndex = leaveHistory.findIndex(item => 
                    item.timestamp === itemToDelete.timestamp && 
                    item.studentName === itemToDelete.studentName
                );
                
                if (originalIndex !== -1) {
                    leaveHistory.splice(originalIndex, 1);
                }
                
                if (filteredLeaveHistory.length > 0) {
                    filteredLeaveHistory.splice(index, 1);
                    displayLeaveData(filteredLeaveHistory);
                } else {
                    displayLeaveData();
                }
                
                updateAdminStats();
                showNotification('ลบข้อมูลสำเร็จ! (โหมดสาธิต)', 'success');
                return;
            }
            
            showLoading(true);
            
            try {
                const form = new FormData();
                form.append('action', 'delete');
                form.append('sheetId', window.CONFIG.SHEET_ID);
                form.append('rowIndex', index + 2);

                const response = await fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(submitData).toString(),
                    mode: 'no-cors'
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('ลบข้อมูลสำเร็จ!', 'success');
                    loadLeaveData();
                } else {
                    throw new Error(result.error || 'เกิดข้อผิดพลาดในการลบข้อมูล');
                }
            } catch (error) {
                showNotification('❌ เกิดข้อผิดพลาด: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        // System Status Functions
        async function checkSystemStatus() {
            if (window.CONFIG.DEMO_MODE) {
                displayDemoSystemStatus();
                showNotification('ตรวจสอบสถานะระบบเรียบร้อย (โหมดสาธิต)', 'success');
                return;
            }

            showLoading(true);
            
            try {
                // Simple system check
                const testData = {
                    action: 'test',
                    sheetId: window.CONFIG.SHEET_ID
                };

                // Perform a simple connectivity test
                await fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(testData).toString(),
                    mode: 'no-cors'
                });

                // Show positive status regardless since we can't read response
                displayDemoSystemStatus();
                showNotification('✅ ระบบทำงานปกติ', 'success');
                
            } catch (error) {
                console.error('Error checking system status:', error);
                
                // Still show demo status as fallback
                displayDemoSystemStatus();
                showNotification('⚠️ แสดงสถานะตัวอย่าง (ระบบกำลังตรวจสอบในพื้นหลัง)', 'info');
            } finally {
                showLoading(false);
            }
        }

        function displayDemoSystemStatus() {
            const systemStatus = document.getElementById('systemStatus');
            
            systemStatus.innerHTML = `
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-database mr-2 text-blue-500"></i>Google Sheets
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>สถานะ:</span>
                            <span class="text-green-600">✅ เชื่อมต่อได้ (สาธิต)</span>
                        </div>
                        <div class="flex justify-between">
                            <span>ชื่อ:</span>
                            <span>ระบบแจ้งลาออนไลน์</span>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>ข้อมูลระบบ
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>เวลาตรวจสอบ:</span>
                            <span>${new Date().toLocaleString('th-TH')}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>สถานะโดยรวม:</span>
                            <span class="text-green-600">✅ ปกติ (โหมดสาธิต)</span>
                        </div>
                        <div class="flex justify-between">
                            <span>เวอร์ชั่น:</span>
                            <span>1.0.0</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function displaySystemStatus(status) {
            const systemStatus = document.getElementById('systemStatus');
            
            systemStatus.innerHTML = `
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-database mr-2 text-blue-500"></i>Google Sheets
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>สถานะ:</span>
                            <span class="${status.sheet?.accessible ? 'text-green-600' : 'text-red-600'}">
                                ${status.sheet?.accessible ? '✅ เชื่อมต่อได้' : '❌ เชื่อมต่อไม่ได้'}
                            </span>
                        </div>
                        ${status.sheet?.name ? `<div class="flex justify-between"><span>ชื่อ:</span><span>${status.sheet.name}</span></div>` : ''}
                    </div>
                </div>
                
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>ข้อมูลระบบ
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>เวลาตรวจสอบ:</span>
                            <span>${status.timestamp}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>สถานะโดยรวม:</span>
                            <span class="${status.success ? 'text-green-600' : 'text-red-600'}">
                                ${status.success ? '✅ ปกติ' : '❌ มีปัญหา'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateAdminStats() {
            const totalRequests = leaveHistory.length;
            const businessLeave = leaveHistory.filter(item => item.leaveType === 'ลากิจ').length;
            const sickLeave = leaveHistory.filter(item => item.leaveType === 'ลาป่วย').length;
            const hourlyLeave = leaveHistory.filter(item => item.leaveType === 'ลารายชั่วโมง').length;

            document.getElementById('totalRequests').textContent = totalRequests;
            document.getElementById('businessLeave').textContent = businessLeave;
            document.getElementById('sickLeave').textContent = sickLeave;
            document.getElementById('hourlyLeave').textContent = hourlyLeave;
        }

        // Export Functions
        function exportToPDF() {
            if (window.CONFIG.DEMO_MODE) {
                showNotification('ส่งออก PDF สำเร็จ! (โหมดสาธิต)', 'success');
                return;
            }
            showNotification('กำลังพัฒนาฟีเจอร์นี้...', 'info');
        }

        function exportToExcel() {
            if (window.CONFIG.DEMO_MODE) {
                showNotification('ส่งออก Excel สำเร็จ! (โหมดสาธิต)', 'success');
                return;
            }
            showNotification('กำลังพัฒนาฟีเจอร์นี้...', 'info');
        }

        function exportToCSV() {
            const dataToExport = filteredLeaveHistory.length > 0 ? filteredLeaveHistory : leaveHistory;
            
            if (dataToExport.length === 0) {
                showNotification('ไม่มีข้อมูลให้ส่งออก', 'error');
                return;
            }

            const headers = ['เวลาส่ง', 'ชื่อ-นามสกุล', 'หลักสูตร', 'ประเภทการลา', 'วันที่เริ่มลา', 'วันที่สิ้นสุด', 'ช่วงเวลา'];
            const csvContent = [
                headers.join(','),
                ...dataToExport.map(item => [
                    `"${item.timestamp}"`,
                    `"${item.studentName}"`,
                    `"${item.course}"`,
                    `"${item.leaveType}"`,
                    `"${formatDate(item.startDate)}"`,
                    `"${formatDate(item.endDate)}"`,
                    `"${getTimeSlotText(item.timeSlot)}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `leave_data_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('ส่งออก CSV สำเร็จ!', 'success');
        }

        function exportToGoogleSheets() {
            if (window.CONFIG.DEMO_MODE) {
                showNotification('เปิด Google Sheets แล้ว! (โหมดสาธิต)', 'success');
                return;
            }
            
            const url = `https://docs.google.com/spreadsheets/d/${window.CONFIG.SHEET_ID}/edit`;
            window.open(url, '_blank');
            showNotification('เปิด Google Sheets แล้ว', 'success');
        }

        // Settings Functions
        async function testGoogleSheets() {
            if (window.CONFIG.DEMO_MODE) {
                showNotification('ทดสอบ Google Sheets สำเร็จ! (โหมดสาธิต)', 'success');
                return;
            }

            showLoading(true);
            showNotification('🔄 กำลังทดสอบการเชื่อมต่อ Google Sheets...', 'info');
            
            try {
                const testData = {
                    action: 'test',
                    sheetId: window.CONFIG.SHEET_ID,
                    timestamp: new Date().toLocaleString('th-TH'),
                    testMessage: 'ทดสอบการเชื่อมต่อจากระบบ'
                };

                const response = await fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(testData).toString(),
                    mode: 'no-cors'
                });

                // Since we can't read response in no-cors mode, assume success
                showNotification('✅ Google Sheets ส่งคำขอสำเร็จ!', 'success');
                showNotification('📊 ระบบกำลังประมวลผลในพื้นหลัง', 'info');
                
            } catch (error) {
                console.error('Google Sheets test error:', error);
                showNotification('❌ ไม่สามารถเชื่อมต่อ Google Sheets: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function testTelegram() {
            if (window.CONFIG.DEMO_MODE) {
                showNotification('ทดสอบ Telegram สำเร็จ! (โหมดสาธิต)', 'success');
                return;
            }

            showLoading(true);
            showNotification('🔄 กำลังทดสอบการส่ง Telegram...', 'info');
            
            try {
                const testMessage = `🧪 ทดสอบระบบ Telegram
                
⏰ เวลา: ${new Date().toLocaleString('th-TH')}
🔧 สถานะ: ทดสอบการเชื่อมต่อ
✅ ระบบ: ทำงานปกติ`;

                const telegramUrl = `https://api.telegram.org/bot${window.CONFIG.TELEGRAM_BOT_TOKEN}/sendMessage`;
                
                // Create fetch promise with timeout
                const fetchPromise = fetch(telegramUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: window.CONFIG.TELEGRAM_CHAT_ID,
                        text: testMessage,
                        parse_mode: 'HTML'
                    }),
                    mode: 'cors'
                });

                // Add timeout protection
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Request timeout')), 10000);
                });

                const response = await Promise.race([fetchPromise, timeoutPromise]);

                if (response.ok) {
                    const result = await response.json();
                    if (result.ok) {
                        showNotification('✅ Telegram ส่งข้อความสำเร็จ!', 'success');
                    } else {
                        showNotification('❌ Telegram ตอบกลับ: ' + (result.description || 'ไม่ทราบสาเหตุ'), 'error');
                    }
                } else {
                    showNotification('❌ Telegram API ตอบสนองแต่มีปัญหา (Status: ' + response.status + ')', 'error');
                }
            } catch (error) {
                console.error('Telegram test error:', error);
                if (error.message.includes('timeout')) {
                    showNotification('⏰ การทดสอบ Telegram หมดเวลา - ลองใหม่อีกครั้ง', 'error');
                } else {
                    showNotification('❌ ไม่สามารถส่ง Telegram: ' + error.message, 'error');
                }
            } finally {
                showLoading(false);
            }
        }

        async function verifyLastSubmission() {
            if (window.CONFIG.DEMO_MODE) {
                showNotification('ตรวจสอบการส่งล่าสุดสำเร็จ! (โหมดสาธิต)', 'success');
                return;
            }

            showLoading(true);
            showNotification('🔍 กำลังตรวจสอบข้อมูลล่าสุดใน Google Sheets...', 'info');
            
            try {
                const verifyData = {
                    action: 'read',
                    sheetId: window.CONFIG.SHEET_ID,
                    timestamp: new Date().toLocaleString('th-TH')
                };

                const response = await fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(verifyData).toString(),
                    mode: 'no-cors'
                });

                // Since we can't read response in no-cors mode, show positive message
                showNotification('✅ ส่งคำขอตรวจสอบแล้ว!', 'success');
                showNotification('📊 ตรวจสอบข้อมูลใน Google Sheets โดยตรง', 'info');
                
            } catch (error) {
                console.error('Verification error:', error);
                showNotification('❌ เกิดข้อผิดพลาดในการตรวจสอบ: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function sendTestData() {
            if (window.CONFIG.DEMO_MODE) {
                showNotification('ส่งข้อมูลทดสอบสำเร็จ! (โหมดสาธิต)', 'success');
                return;
            }

            const confirmed = await showCustomConfirm('ต้องการส่งข้อมูลทดสอบไปยัง Google Sheets และ Telegram หรือไม่?');
            if (!confirmed) return;

            showLoading(true);
            showNotification('🧪 กำลังส่งข้อมูลทดสอบ...', 'info');
            
            try {
                const testData = {
                    action: 'create',
                    sheetId: window.CONFIG.SHEET_ID,
                    headers: JSON.stringify(window.CONFIG.SHEET_HEADERS),
                    // Map data to correct columns based on SHEET_HEADERS order
                    col1: new Date().toLocaleString('th-TH'),           // เวลาที่ส่ง
                    col2: 'ทดสอบระบบ (Test)',                          // ชื่อ-นามสกุล  
                    col3: 'หลักสูตรเสนาธิการทหาร',                      // หลักสูตร
                    col4: 'ลากิจ',                                     // ประเภทการลา
                    col5: new Date().toISOString().split('T')[0],       // วันที่เริ่มลา
                    col6: new Date().toISOString().split('T')[0],       // วันที่สิ้นสุดการลา
                    col7: '',                                          // ช่วงเวลา (ถ้ามี)
                    col8: 'ไฟล์ทดสอบ.pdf (100 KB)'                     // ข้อมูลไฟล์แนบ (ถ้ามี)
                };

                // Test Google Sheets
                const sheetsResponse = await fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(testData).toString(),
                    mode: 'no-cors'
                });

                // Assume success since we can't read response in no-cors mode
                let sheetsSuccess = true;

                // Test Telegram
                const telegramMessage = `🧪 ข้อมูลทดสอบระบบ
                
👤 ชื่อ: ${testData.col2}
🎓 หลักสูตร: ${testData.col3}
📋 ประเภท: ${testData.col4}
📅 วันที่: ${formatDate(testData.col5)}
🕐 เวลาส่ง: ${testData.col1}
                
⚠️ นี่คือข้อมูลทดสอบระบบ`;

                const telegramUrl = `https://api.telegram.org/bot${window.CONFIG.TELEGRAM_BOT_TOKEN}/sendMessage`;
                
                const telegramResponse = await fetch(telegramUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: window.CONFIG.TELEGRAM_CHAT_ID,
                        text: telegramMessage,
                        parse_mode: 'HTML'
                    }),
                    mode: 'cors'
                });

                let telegramSuccess = false;
                if (telegramResponse.ok) {
                    const telegramResult = await telegramResponse.json();
                    telegramSuccess = telegramResult.ok;
                }

                // Show results
                if (sheetsSuccess && telegramSuccess) {
                    showNotification('✅ ส่งข้อมูลทดสอบสำเร็จทั้ง Google Sheets และ Telegram!', 'success');
                } else if (sheetsSuccess) {
                    showNotification('⚠️ Google Sheets สำเร็จ แต่ Telegram ล้มเหลว', 'error');
                } else if (telegramSuccess) {
                    showNotification('⚠️ Telegram สำเร็จ แต่ Google Sheets ล้มเหลว', 'error');
                } else {
                    showNotification('❌ ทั้ง Google Sheets และ Telegram ล้มเหลว', 'error');
                }

            } catch (error) {
                console.error('Test data error:', error);
                showNotification('❌ เกิดข้อผิดพลาดในการส่งข้อมูลทดสอบ: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function clearAllData() {
            const confirmed = await showCustomConfirm('คุณต้องการลบข้อมูลทั้งหมดหรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้');
            if (!confirmed) return;

            if (window.CONFIG.DEMO_MODE) {
                leaveHistory = [];
                filteredLeaveHistory = [];
                displayLeaveData();
                updateAdminStats();
                showNotification('ล้างข้อมูลทั้งหมดสำเร็จ! (โหมดสาธิต)', 'success');
                return;
            }
            
            showNotification('กำลังพัฒนาฟีเจอร์นี้...', 'info');
        }

        function backupData() {
            if (window.CONFIG.DEMO_MODE) {
                exportToCSV(); // Use CSV export as backup in demo mode
                return;
            }
            showNotification('กำลังพัฒนาฟีเจอร์นี้...', 'info');
        }

        async function testFileUpload() {
            if (window.CONFIG.DEMO_MODE) {
                showNotification('ทดสอบอัปโหลดไฟล์สำเร็จ! (โหมดสาธิต)', 'success');
                return;
            }

            const confirmed = await showCustomConfirm('ต้องการทดสอบการอัปโหลดไฟล์ไปยัง Google Drive หรือไม่?');
            if (!confirmed) return;

            showLoading(true);
            showNotification('📁 กำลังทดสอบการอัปโหลดไฟล์...', 'info');
            
            try {
                // Create a test text file
                const testContent = `ไฟล์ทดสอบระบบ
เวลา: ${new Date().toLocaleString('th-TH')}
ระบบ: ระบบแจ้งลาออนไลน์
สถานะ: ทดสอบการอัปโหลด Google Drive

นี่คือไฟล์ทดสอบเพื่อตรวจสอบการทำงานของระบบอัปโหลดไฟล์`;

                const testFile = new Blob([testContent], { type: 'text/plain' });
                testFile.name = `test_upload_${Date.now()}.txt`;

                const testLeaveData = {
                    studentName: 'ทดสอบระบบ',
                    leaveType: 'ทดสอบ',
                    timestamp: new Date().toLocaleString('th-TH')
                };

                // Test file upload
                const uploadResult = await uploadSingleFileToDrive(testFile, testLeaveData);
                
                if (uploadResult) {
                    showNotification('✅ ทดสอบอัปโหลดไฟล์สำเร็จ!', 'success');
                    showNotification(`📁 ไฟล์: ${uploadResult.fileName}`, 'info');
                    showNotification(`🔗 ตรวจสอบใน Google Drive: ${uploadResult.url}`, 'info');
                } else {
                    showNotification('❌ ทดสอบอัปโหลดไฟล์ล้มเหลว', 'error');
                }

            } catch (error) {
                console.error('Test file upload error:', error);
                showNotification('❌ เกิดข้อผิดพลาดในการทดสอบอัปโหลดไฟล์: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // File Upload Functions
        async function uploadFilesToDrive(files, leaveData) {
            const uploadedFiles = [];
            
            for (const file of files) {
                try {
                    const uploadResult = await uploadSingleFileToDrive(file, leaveData);
                    if (uploadResult) {
                        uploadedFiles.push(uploadResult);
                    }
                } catch (error) {
                    console.error(`Error uploading file ${file.name}:`, error);
                    // Continue with other files even if one fails
                }
            }
            
            return uploadedFiles;
        }

        async function uploadSingleFileToDrive(file, leaveData) {
            try {
                // Convert file to base64
                const base64Data = await fileToBase64(file);
                
                // Create filename with timestamp and student name
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const studentName = leaveData.studentName.replace(/[^a-zA-Z0-9ก-๙]/g, '_');
                const fileExtension = file.name.split('.').pop();
                const fileName = `${timestamp}_${studentName}_${file.name}`;
                
                // Prepare upload data
                const uploadData = {
                    action: 'uploadFile',
                    folderId: window.CONFIG.DRIVE_FOLDER_ID,
                    fileName: fileName,
                    fileData: base64Data,
                    mimeType: file.type,
                    studentName: leaveData.studentName,
                    leaveType: leaveData.leaveType,
                    timestamp: leaveData.timestamp
                };

                // Upload to Google Drive via Apps Script with timeout
                const uploadPromise = fetch(window.CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(uploadData).toString(),
                    mode: 'no-cors'
                });

                // Add timeout protection for file upload
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('File upload timeout')), 15000);
                });

                await Promise.race([uploadPromise, timeoutPromise]);
                
                // Since we can't read response in no-cors mode, create a mock successful response
                const driveUrl = `https://drive.google.com/drive/folders/${window.CONFIG.DRIVE_FOLDER_ID}`;
                
                return {
                    name: file.name,
                    size: formatFileSize(file.size),
                    url: driveUrl,
                    fileName: fileName
                };
                
            } catch (error) {
                console.error('Single file upload error:', error);
                throw error;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Remove data:mime/type;base64, prefix
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const thaiMonths = [
                'ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
                'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'
            ];
            
            const day = date.getDate();
            const month = thaiMonths[date.getMonth()];
            const year = date.getFullYear() + 543;
            
            return `${day} ${month} ${year}`;
        }

        function getTimeSlotText(timeSlot) {
            if (!timeSlot) return '';
            return timeSlot === '0930-1130' ? 'ช่วงเช้า (09:30-11:30)' : 'ช่วงบ่าย (12:30-15:30)';
        }

        function showSuccessModal(data) {
            const modal = document.getElementById('successModal');
            const dataDiv = document.getElementById('submittedData');
            
            let timeSlotText = '';
            if (data.timeSlot) {
                timeSlotText = getTimeSlotText(data.timeSlot);
            }
            
            const startDateFormatted = formatDate(data.startDate);
            const endDateFormatted = formatDate(data.endDate);
            
            dataDiv.innerHTML = `
                <div class="space-y-2">
                    <div><strong>เวลาส่ง:</strong> ${data.timestamp}</div>
                    <div><strong>ชื่อ-นามสกุล:</strong> ${data.studentName}</div>
                    <div><strong>หลักสูตร:</strong> ${data.course}</div>
                    <div><strong>ประเภทการลา:</strong> ${data.leaveType}</div>
                    <div><strong>วันที่เริ่มลา:</strong> ${startDateFormatted}</div>
                    <div><strong>วันที่สิ้นสุด:</strong> ${endDateFormatted}</div>
                    ${timeSlotText ? `<div><strong>ช่วงเวลา:</strong> ${timeSlotText}</div>` : ''}
                    ${data.filesInfo ? `<div><strong>ไฟล์แนบ:</strong> ${data.filesInfo}</div>` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            } else {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        }

        function showNotification(message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 4000);
        }

        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const messageElement = document.getElementById('confirmMessage');
                
                messageElement.textContent = message;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                confirmCallback = resolve;
            });
        }

        function confirmAction(confirmed) {
            const modal = document.getElementById('confirmModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            
            if (confirmCallback) {
                confirmCallback(confirmed);
                confirmCallback = null;
            }
        }

        // Helper functions for admin forms
        function toggleAddTimeSlot() {
            const leaveType = document.getElementById('addLeaveType').value;
            const timeSlotSection = document.getElementById('addTimeSlotSection');
            
            if (leaveType === 'ลารายชั่วโมง') {
                timeSlotSection.classList.remove('hidden');
            } else {
                timeSlotSection.classList.add('hidden');
                document.getElementById('addTimeSlot').value = '';
            }
        }

        function updateAddEndDateMin() {
            const startDate = document.getElementById('addStartDate').value;
            const endDateInput = document.getElementById('addEndDate');
            
            if (startDate) {
                endDateInput.min = startDate;
                if (endDateInput.value && endDateInput.value < startDate) {
                    endDateInput.value = startDate;
                }
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97bb92c26696893b',t:'MTc1NzMwNDM4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
